<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор бассейна</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-label {
            font-weight: 500;
        }
        .result-section {
            margin-top: 30px;
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .total-cost {
            font-weight: bold;
            font-size: 1.2em;
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* Стили для коммерческого предложения */
        #kp-container {
            font-family: 'Times New Roman', Times, serif;
        }
        
        #kp-container .card {
            border: none;
            box-shadow: none;
        }
        
        #kp-content {
            padding: 20px;
            background-color: white;
            border: 1px solid #dee2e6;
        }
        
        #kp-container h3, 
        #kp-container h4, 
        #kp-container h5 {
            font-weight: bold;
            color: #333;
        }
        
        #kp-container .table {
            border: 1px solid #000;
        }
        
        #kp-container .table th,
        #kp-container .table td {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: middle;
        }
        
        #kp-container .table th {
            background-color: #f5f5f5;
        }
        
        #kp-equipment-text,
        #kp-materials-text,
        #kp-works-text,
        #kp-grand-total-text {
            white-space: pre-line;
            font-style: italic;
        }
        
        /* Стили для печати */
        @media print {
            body {
                padding: 0;
                background-color: white;
            }
            .container {
                max-width: 100%;
                width: 100%;
            }
            .card {
                box-shadow: none;
                border: none;
            }
            .card-body {
                padding: 0;
            }
            #poolForm, 
            #results, 
            #errorMessage, 
            #compare-section,
            #comparison-result,
            #kp-print-btn,
            #kp-back-btn {
                display: none !important;
            }
            #kp-container {
                display: block !important;
            }
            .hidden {
                display: block !important;
            }
            .table {
                width: 100%;
                border-collapse: collapse;
            }
            .table th, .table td {
                border: 1px solid #000;
            }
            h3, h4, h5 {
                margin-top: 20px;
            }
            @page {
                size: A4;
                margin: 1cm;
            }
            
            #kp-content {
                padding: 0;
                border: none;
            }
            
            #kp-container .table th,
            #kp-container .table td {
                padding: 5px;
            }
            
            #kp-container h3 {
                font-size: 18pt;
            }
            
            #kp-container h4 {
                font-size: 16pt;
            }
            
            #kp-container h5 {
                font-size: 14pt;
            }
            
            #kp-container .card {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Калькулятор стоимости бассейна</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Параметры бассейна</h5>
                <form id="poolForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="length" class="form-label">Длина (мм)</label>
                                <input type="number" class="form-control" id="length" required min="0" step="100">
                        </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="width" class="form-label">Ширина (мм)</label>
                                <input type="number" class="form-control" id="width" required min="0" step="100">
                        </div>
                    </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="depth" class="form-label">Глубина (мм)</label>
                                <input type="number" class="form-control" id="depth" required min="0" step="50">
                        </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="wall_thickness" class="form-label">Толщина стен (мм)</label>
                                <input type="number" class="form-control" id="wall_thickness" required min="0" step="10">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="profile" class="form-label">Профиль КП</label>
                                <select class="form-select" id="profile" required>
                                    <option value="kp1">КП №1 (8000x4000x1500)</option>
                                    <option value="kp2">КП №2 (8000x3000x1500)</option>
                                    <option value="kp3">КП №3 (8000x3000x1500) - Упрощенный</option>
                            </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">Рассчитать</button>
                            </div>
                        </div>
                    </div>
                </form>
                        </div>
                    </div>
                    
        <!-- Форма для ввода данных заказчика перед генерацией КП -->
        <div id="customer-data-form" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Данные заказчика</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="customerForm">
                            <div class="mb-3">
                                <label for="customer-name" class="form-label">Имя заказчика</label>
                                <input type="text" class="form-control" id="customer-name" value="Владимир">
                            </div>
                            <div class="mb-3">
                                <label for="customer-phone" class="form-label">Телефон</label>
                                <input type="text" class="form-control" id="customer-phone" value="8(928) 118-67-27">
                            </div>
                            <div class="mb-3">
                                <label for="customer-address" class="form-label">Адрес объекта</label>
                                <input type="text" class="form-control" id="customer-address" value="Таганрог">
                            </div>
                            <div class="mb-3">
                                <label for="customer-location" class="form-label">Место размещения</label>
                                <input type="text" class="form-control" id="customer-location" value="Улица">
                    </div>
                </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="generate-kp-submit">Сгенерировать КП</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="results" class="result-section hidden">
            <h2 class="text-center mb-4">Результаты расчета</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Основные размеры</h5>
                        </div>
                        <div class="card-body" id="basicDimensions">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Земляные работы</h5>
                        </div>
                        <div class="card-body" id="earthworks">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Бетонные работы</h5>
                        </div>
                        <div class="card-body" id="concrete">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">Опалубка и армирование</h5>
                        </div>
                        <div class="card-body" id="formwork">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card result-card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Отделочные работы</h5>
                        </div>
                        <div class="card-body" id="finishing">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">Стоимость материалов</h5>
                        </div>
                        <div class="card-body" id="materialsCost">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Стоимость работ</h5>
                        </div>
                        <div class="card-body" id="worksCost">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Стоимость оборудования</h5>
                        </div>
                        <div class="card-body" id="equipmentCost">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card result-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Итоговая стоимость</h5>
                        </div>
                        <div class="card-body" id="totalCost">
                            <!-- Будет заполнено JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Код для сравнения КП -->
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Сравнение с коммерческим предложением</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основные размеры из КП</h6>
                        <div class="mb-3">
                            <label for="kp-water-surface" class="form-label">Площадь водной поверхности (м²)</label>
                            <input type="number" class="form-control" id="kp-water-surface" value="32">
                        </div>
                        <div class="mb-3">
                            <label for="kp-perimeter" class="form-label">Периметр (м/п)</label>
                            <input type="number" class="form-control" id="kp-perimeter" value="26">
                        </div>
                        <div class="mb-3">
                            <label for="kp-wall-area" class="form-label">Площадь стен (м²)</label>
                            <input type="number" class="form-control" id="kp-wall-area" value="39.6">
                        </div>
                        <div class="mb-3">
                            <label for="kp-finishing-area" class="form-label">Площадь под отделку (м²)</label>
                            <input type="number" class="form-control" id="kp-finishing-area" value="71.6">
                        </div>
                        <div class="mb-3">
                            <label for="kp-water-volume" class="form-label">Объем воды (м³)</label>
                            <input type="number" class="form-control" id="kp-water-volume" value="48">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Стоимость из КП</h6>
                        <div class="mb-3">
                            <label for="kp-materials-cost" class="form-label">Стоимость материалов (руб)</label>
                            <input type="number" class="form-control" id="kp-materials-cost" value="817876">
                        </div>
                        <div class="mb-3">
                            <label for="kp-work-cost" class="form-label">Стоимость работ (руб)</label>
                            <input type="number" class="form-control" id="kp-work-cost" value="931860">
                        </div>
                        <div class="mb-3">
                            <label for="kp-equipment-cost" class="form-label">Стоимость оборудования (руб)</label>
                            <input type="number" class="form-control" id="kp-equipment-cost" value="1149928">
                        </div>
                        <div class="mb-3">
                            <label for="kp-total-cost" class="form-label">Общая стоимость (руб)</label>
                            <input type="number" class="form-control" id="kp-total-cost" value="2899664">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-primary w-100" id="compare-btn">Сравнить с расчетами</button>
                        <!-- Индикатор загрузки -->
                        <div id="loading-message" class="alert alert-info mt-3 d-none text-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <span>Выполняется сравнение...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Результат сравнения -->
        <div class="card mt-4 d-none" id="comparison-result">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Результаты сравнения</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Сравнение основных размеров</h6>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Параметр</th>
                                    <th>Калькулятор</th>
                                    <th>КП</th>
                                    <th>Разница</th>
                                </tr>
                            </thead>
                            <tbody id="dimensions-comparison">
                                <!-- Сюда будут добавлены данные через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Сравнение стоимости</h6>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Статья расходов</th>
                                    <th>Калькулятор</th>
                                    <th>КП</th>
                                    <th>Разница</th>
                                </tr>
                            </thead>
                            <tbody id="costs-comparison">
                                <!-- Сюда будут добавлены данные через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Коммерческое предложение в формате ООО "ДОН БАСС" -->
        <div id="kp-container" class="result-section hidden mt-5 mb-5">
            <div class="card">
                <div class="card-body">
                    <div id="kp-content">
                        <div class="text-center mb-4">
                            <h3 id="kp-company-name">Компания ООО "ДОН БАСС"</h3>
                            <p id="kp-company-email">ooo.donbass61@mail.ru</p>
                            <p id="kp-company-website">https://ooodonbass.ru/</p>
                            <p id="kp-company-phone">tel:+7(938) 158-11-11</p>
                            
                            <div class="my-4">
                                <img src="https://ooodonbass.ru/wp-content/uploads/2019/09/logo-1.svg" alt="ДОН БАСС" style="max-width: 200px;">
                            </div>
                            
                            <h4>Коммерческое предложение от <span id="kp-date">04.02.2025</span> года</h4>
                        </div>
                        
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <tr>
                                    <td width="33%">Заказчик:</td>
                                    <td id="kp-customer-name" width="33%">Владимир</td>
                                    <td width="34%">Размеры:</td>
                                </tr>
                                <tr>
                                    <td>Телефон:</td>
                                    <td id="kp-customer-phone">8(928) 118-67-27</td>
                                    <td>Длина:</td>
                                </tr>
                                <tr>
                                    <td>Адрес объекта:</td>
                                    <td id="kp-customer-address">Таганрог</td>
                                    <td>Ширина:</td>
                                </tr>
                                <tr>
                                    <td>Место размещения:</td>
                                    <td id="kp-customer-location">Улица</td>
                                    <td>Глубина,1:</td>
                                </tr>
                                <tr>
                                    <td>Тип бассейна:</td>
                                    <td id="kp-pool-type">Скиммерный</td>
                                    <td>Глубина,2:</td>
                                </tr>
                                <tr>
                                    <td>Отделка чаши:</td>
                                    <td id="kp-pool-finish">Лайнер</td>
                                    <td>Глубина (ср):</td>
                                </tr>
                                <tr>
                                    <td>Форма:</td>
                                    <td id="kp-pool-shape">Прямоугольный</td>
                                    <td>V (объем):</td>
                                </tr>
                                <tr>
                                    <td>Категория:</td>
                                    <td id="kp-pool-category">Частный</td>
                                    <td>Р (периметр):</td>
                                </tr>
                                <tr>
                                    <td colspan="2"></td>
                                    <td>S (зеркало):</td>
                                </tr>
                                <tr>
                                    <td colspan="2"></td>
                                    <td>S (стен):</td>
                                </tr>
                                <tr>
                                    <td colspan="2"></td>
                                    <td>S (под отделку):</td>
                                </tr>
                            </table>
                        </div>
                        
                        <h5 class="text-center mb-3">Основное оборудование</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Наименование</th>
                                        <th>Ед.изм</th>
                                        <th>Кол-во</th>
                                        <th>Цена</th>
                                        <th>Сумма</th>
                                    </tr>
                                </thead>
                                <tbody id="kp-equipment-items">
                                    <!-- Будет заполнено JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-end fw-bold">Итого:</td>
                                        <td id="kp-equipment-total" class="fw-bold"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <p id="kp-equipment-text" class="mb-4 text-center"></p>
                        
                        <h5 class="text-center mb-3">Материал и расходы для выполнения работ</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Наименование</th>
                                        <th>Ед.изм</th>
                                        <th>Кол-во</th>
                                        <th>Цена</th>
                                        <th>Сумма</th>
                                    </tr>
                                </thead>
                                <tbody id="kp-materials-items">
                                    <!-- Будет заполнено JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-end fw-bold">Итого:</td>
                                        <td id="kp-materials-total" class="fw-bold"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <p id="kp-materials-text" class="mb-4 text-center"></p>
                        
                        <h5 class="text-center mb-3">Основные работы</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Наименование</th>
                                        <th>Ед.изм</th>
                                        <th>Кол-во</th>
                                        <th>Цена</th>
                                        <th>Сумма</th>
                                    </tr>
                                </thead>
                                <tbody id="kp-works-items">
                                    <!-- Будет заполнено JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-end fw-bold">Итого:</td>
                                        <td id="kp-works-total" class="fw-bold"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <p id="kp-works-text" class="mb-4 text-center"></p>
                        
                        <h5 class="text-center mb-3">Итого по 3 позициям:</h5>
                        <div class="text-center mb-5">
                            <h4 id="kp-grand-total" class="fw-bold"></h4>
                            <p id="kp-grand-total-text" class="fw-bold"></p>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="kp-print-btn" class="btn btn-primary">Печать КП</button>
                            <button id="kp-back-btn" class="btn btn-secondary ms-2">Вернуться</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="errorMessage" class="hidden">
        <div class="alert alert-danger" role="alert">
            <strong>Ошибка:</strong>
            <span id="errorText"></span>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.getElementById('poolForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const length = parseFloat(document.getElementById('length').value);
            const width = parseFloat(document.getElementById('width').value);
            const depth = parseFloat(document.getElementById('depth').value);
            const wall_thickness = parseFloat(document.getElementById('wall_thickness').value);
            
            // Проверяем наличие элемента profile в форме
            let profile_id = "kp1"; // Значение по умолчанию
            const profileElement = document.getElementById('profile');
            if (profileElement) {
                profile_id = profileElement.value;
            }
            
            // Создаем объект с данными запроса
            const data = {
                length: length,
                width: width,
                depth: depth,
                wall_thickness: wall_thickness,
                profile_id: profile_id
            };
            
            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                displayResults(result);
                
            } catch (error) {
                alert('Произошла ошибка при расчете: ' + error.message);
            }
        });

        $(document).ready(function() {
            // Код для сравнения с КП
            $("#compare-btn").click(function() {
                try {
                    // Показываем индикатор загрузки или сообщение
                    $("#loading-message").removeClass("d-none").text("Выполняется сравнение...");
                    
                    // Получаем параметры бассейна из формы
                    const length = parseFloat($("#length").val() || 0);
                    const width = parseFloat($("#width").val() || 0);
                    const depth = parseFloat($("#depth").val() || 0);
                    const wallThickness = parseFloat($("#wall_thickness").val() || 0);
                    
                    // Получаем тип бассейна и определяем соответствующий profile_id
                    const poolType = $("#pool_type").val() || "liner";
                    let profile_id = "kp1"; // Значение по умолчанию
                    
                    // Конвертируем pool_type в profile_id
                    if (poolType === "liner") {
                        profile_id = "kp1";
                    } else if (poolType === "tile") {
                        profile_id = "kp2";
                    } else if (poolType === "mosaic") {
                        profile_id = "kp3";
                    }
                    
                    // Получаем данные из КП и преобразуем их в числа
                    const estimateData = {
                        water_surface: parseFloat($("#kp-water-surface").val() || 0),
                        perimeter: parseFloat($("#kp-perimeter").val() || 0),
                        wall_area: parseFloat($("#kp-wall-area").val() || 0),
                        finishing_area: parseFloat($("#kp-finishing-area").val() || 0),
                        water_volume: parseFloat($("#kp-water-volume").val() || 0),
                        materials_cost: parseFloat($("#kp-materials-cost").val() || 0),
                        work_cost: parseFloat($("#kp-work-cost").val() || 0),
                        equipment_cost: parseFloat($("#kp-equipment-cost").val() || 0),
                        total_cost: parseFloat($("#kp-total-cost").val() || 0)
                    };
                    
                    // Проверяем наличие обязательных параметров
                    if (!length || !width || !depth || !wallThickness) {
                        throw new Error("Пожалуйста, укажите все размеры бассейна");
                    }
                    
                    // Отправляем запрос на сервер
                    fetch("/compare_estimate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            length: length,
                            width: width,
                            depth: depth,
                            wall_thickness: wallThickness,
                            pool_type: poolType,
                            profile_id: profile_id,
                            estimate: estimateData
                        })
                    })
                    .then(response => {
                        // Скрываем индикатор загрузки
                        $("#loading-message").addClass("d-none");
                        
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || 'Произошла ошибка при сравнении');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Проверяем полученные данные
                        console.log("Получены данные сравнения:", data);
                        
                        if (data.success && data.comparison) {
                            // Показываем результат сравнения
                            $("#comparison-result").removeClass("d-none");
                            
                            // Заполняем таблицу сравнения размеров
                            const dimensions = data.comparison.dimensions;
                            let dimensionsHtml = "";
                            
                            // Функция для создания строки сравнения с проверкой данных
                            function createSafeComparisonRow(label, dimension) {
                                if (!dimension) return "";
                                
                                const calc = dimension.calc !== undefined ? formatNumber(dimension.calc) : "0";
                                const estimate = dimension.estimate !== undefined ? formatNumber(dimension.estimate) : "0";
                                const diff = dimension.diff !== undefined ? formatNumber(dimension.diff) : "0";
                                
                                return createComparisonRow(label, calc, estimate, diff);
                            }
                            
                            if (dimensions) {
                                dimensionsHtml += createSafeComparisonRow("Площадь водной поверхности (м²)", dimensions.water_surface);
                                dimensionsHtml += createSafeComparisonRow("Периметр (м/п)", dimensions.perimeter);
                                dimensionsHtml += createSafeComparisonRow("Площадь стен (м²)", dimensions.wall_area);
                                dimensionsHtml += createSafeComparisonRow("Площадь под отделку (м²)", dimensions.finishing_area);
                                dimensionsHtml += createSafeComparisonRow("Объем воды (м³)", dimensions.water_volume);
                            } else {
                                dimensionsHtml = "<tr><td colspan='4' class='text-center'>Нет данных для сравнения размеров</td></tr>";
                            }
                            
                            $("#dimensions-comparison").html(dimensionsHtml);
                            
                            // Заполняем таблицу сравнения стоимости
                            const costs = data.comparison.costs;
                            let costsHtml = "";
                            
                            if (costs) {
                                costsHtml += createSafeComparisonRow("Материалы (руб)", costs.materials);
                                costsHtml += createSafeComparisonRow("Работы (руб)", costs.work);
                                costsHtml += createSafeComparisonRow("Оборудование (руб)", costs.equipment);
                                costsHtml += createSafeComparisonRow("Итого (руб)", costs.total, true);
                            } else {
                                costsHtml = "<tr><td colspan='4' class='text-center'>Нет данных для сравнения стоимости</td></tr>";
                            }
                            
                            $("#costs-comparison").html(costsHtml);
                            
                            // Прокручиваем страницу к результатам
                            $('html, body').animate({
                                scrollTop: $("#comparison-result").offset().top - 20
                            }, 500);
                        } else {
                            alert("Ошибка при сравнении: " + (data.error || "Неизвестная ошибка"));
                        }
                    })
                    .catch(error => {
                        // Скрываем индикатор загрузки
                        $("#loading-message").addClass("d-none");
                        
                        console.error("Ошибка:", error);
                        alert("Ошибка при отправке запроса: " + error.message);
                    });
                } catch (error) {
                    // Скрываем индикатор загрузки
                    $("#loading-message").addClass("d-none");
                    
                    alert("Ошибка: " + error.message);
                }
            });
            
            // Функция для создания строки сравнения
            function createComparisonRow(label, calc, estimate, diff, isTotal = false) {
                const diffNum = parseFloat(diff.replace(/\s/g, "").replace(",", "."));
                const diffClass = diffNum > 0 ? "text-danger" : (diffNum < 0 ? "text-success" : "");
                const diffPrefix = diffNum > 0 ? "+" : "";
                
                let rowClass = isTotal ? "fw-bold" : "";
                
                return `<tr class="${rowClass}">
                    <td>${label}</td>
                    <td>${calc}</td>
                    <td>${estimate}</td>
                    <td class="${diffClass}">${diffPrefix}${diff}</td>
                </tr>`;
            }
            
            // Функция для форматирования чисел
            function formatNumber(num) {
                if (num === undefined || num === null) {
                    return "0";
                }
                return parseFloat(num).toLocaleString('ru-RU');
            }
        });

        // Код для генерации КП в формате ООО "ДОН БАСС"
        document.getElementById('generateKpBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Показываем модальное окно для ввода данных заказчика
            const customerModal = new bootstrap.Modal(document.getElementById('customer-data-form'));
            customerModal.show();
        });
        
        // Обработчик для кнопки в модальном окне
        document.getElementById('generate-kp-submit').addEventListener('click', function() {
            // Получаем данные заказчика из формы
            const customerData = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value,
                location: document.getElementById('customer-location').value
            };
            
            // Получаем параметры бассейна из основной формы
            const formData = {
                length: parseInt(document.getElementById('length').value),
                width: parseInt(document.getElementById('width').value),
                depth: parseInt(document.getElementById('depth').value),
                wall_thickness: parseInt(document.getElementById('wall_thickness').value),
                pool_type: document.getElementById('profile').value,
                customer: customerData
            };
            
            // Закрываем модальное окно
            const customerModal = bootstrap.Modal.getInstance(document.getElementById('customer-data-form'));
            customerModal.hide();
            
            // Отправляем запрос на сервер
            fetch('/generate_kp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Произошла ошибка при генерации КП');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayKP(data.kp_data);
                    document.getElementById('kp-container').classList.remove('hidden');
                    document.getElementById('results').classList.add('hidden');
                document.getElementById('errorMessage').classList.add('hidden');
                    
                    // Прокручиваем страницу к КП
                    window.scrollTo({
                        top: document.getElementById('kp-container').offsetTop,
                        behavior: 'smooth'
                    });
                } else {
                    throw new Error(data.error || 'Произошла ошибка при генерации КП');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message || 'Произошла ошибка при генерации КП. Пожалуйста, попробуйте еще раз.';
            });
        });
        
        function displayKP(kpData) {
            // Форматирование чисел
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value);
            };
            
            // Заполняем данные компании
            document.getElementById('kp-company-name').textContent = kpData.company.name;
            document.getElementById('kp-company-email').textContent = kpData.company.email;
            document.getElementById('kp-company-website').textContent = kpData.company.website;
            document.getElementById('kp-company-phone').textContent = kpData.company.phone;
            
            // Заполняем дату
            document.getElementById('kp-date').textContent = `${kpData.date.day}.${kpData.date.month}.${kpData.date.year}`;
            
            // Заполняем данные заказчика
            document.getElementById('kp-customer-name').textContent = kpData.customer.name;
            document.getElementById('kp-customer-phone').textContent = kpData.customer.phone;
            document.getElementById('kp-customer-address').textContent = kpData.customer.address;
            document.getElementById('kp-customer-location').textContent = kpData.customer.location;
            
            // Заполняем данные бассейна
            document.getElementById('kp-pool-type').textContent = kpData.pool.type;
            document.getElementById('kp-pool-finish').textContent = kpData.pool.finish;
            document.getElementById('kp-pool-shape').textContent = kpData.pool.shape;
            document.getElementById('kp-pool-category').textContent = kpData.pool.category;
            
            // Обновляем размеры в правой колонке
            const table = document.querySelector('#kp-container table');
            table.rows[1].cells[2].textContent = `Длина: ${kpData.pool.length}`;
            table.rows[2].cells[2].textContent = `Ширина: ${kpData.pool.width}`;
            table.rows[3].cells[2].textContent = `Глубина,1: ${kpData.pool.depth}`;
            table.rows[4].cells[2].textContent = `Глубина,2: ${kpData.pool.depth}`;
            table.rows[5].cells[2].textContent = `Глубина (ср): ${kpData.pool.depth}`;
            table.rows[6].cells[2].textContent = `V (объем): ${formatCurrency(kpData.pool.water_volume)} л`;
            table.rows[7].cells[2].textContent = `Р (периметр): ${formatCurrency(kpData.pool.perimeter)} м/п`;
            table.rows[8].cells[2].textContent = `S (зеркало): ${formatCurrency(kpData.pool.water_surface)} м²`;
            table.rows[9].cells[2].textContent = `S (стен): ${formatCurrency(kpData.pool.wall_area)} м²`;
            table.rows[10].cells[2].textContent = `S (под отделку): ${formatCurrency(kpData.pool.finishing_area)} м²`;
            
            // Заполняем таблицу оборудования
            let equipmentHtml = '';
            kpData.equipment.items.forEach((item, index) => {
                equipmentHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${item.qty}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.qty * item.price)}</td>
                    </tr>
                `;
            });
            document.getElementById('kp-equipment-items').innerHTML = equipmentHtml;
            document.getElementById('kp-equipment-total').textContent = formatCurrency(kpData.equipment.total);
            
            // Формируем текст под таблицей оборудования
            document.getElementById('kp-equipment-text').textContent = `Всего наименований ${kpData.equipment.count}, на сумму ${formatCurrency(kpData.equipment.total)} рублей`;
            document.getElementById('kp-equipment-text').textContent += `\n${kpData.equipment.total_text}`;
            
            // Заполняем таблицу материалов
            let materialsHtml = '';
            kpData.materials.items.forEach((item, index) => {
                materialsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${item.qty}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.qty * item.price)}</td>
                    </tr>
                `;
            });
            document.getElementById('kp-materials-items').innerHTML = materialsHtml;
            document.getElementById('kp-materials-total').textContent = formatCurrency(kpData.materials.total);
            
            // Формируем текст под таблицей материалов
            document.getElementById('kp-materials-text').textContent = `Всего наименований ${kpData.materials.count}, на сумму ${formatCurrency(kpData.materials.total)} рублей`;
            document.getElementById('kp-materials-text').textContent += `\n${kpData.materials.total_text}`;
            
            // Заполняем таблицу работ
            let worksHtml = '';
            kpData.works.items.forEach((item, index) => {
                worksHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${item.qty}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.qty * item.price)}</td>
                    </tr>
                `;
            });
            document.getElementById('kp-works-items').innerHTML = worksHtml;
            document.getElementById('kp-works-total').textContent = formatCurrency(kpData.works.total);
            
            // Формируем текст под таблицей работ
            document.getElementById('kp-works-text').textContent = `Всего наименований ${kpData.works.count}, на сумму ${formatCurrency(kpData.works.total)} рублей`;
            document.getElementById('kp-works-text').textContent += `\n${kpData.works.total_text}`;
            
            // Итоговая сумма
            document.getElementById('kp-grand-total').textContent = `${formatCurrency(kpData.total)} рублей`;
            document.getElementById('kp-grand-total-text').textContent = kpData.total_text;
        }
        
        // Печать КП
        document.getElementById('kp-print-btn').addEventListener('click', function() {
            window.print();
        });
        
        // Кнопка возврата
        document.getElementById('kp-back-btn').addEventListener('click', function() {
            document.getElementById('kp-container').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        });

        function displayResults(data) {
            // Проверяем, что данные корректны
            if (!data) {
                console.error("Получены пустые данные от сервера");
                alert("Произошла ошибка при получении данных. Пожалуйста, попробуйте еще раз.");
                return;
            }
            
            // Показываем результаты
            const resultsElement = document.getElementById('results');
            if (resultsElement) {
                resultsElement.classList.remove('hidden');
            } else {
                console.error("Не найден элемент с ID 'results'");
            }
            
            // Форматирование чисел
            const formatCurrency = (value) => {
                if (value === undefined || value === null) return "0 ₽";
                return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value);
            };
            
            // Функция безопасного доступа к свойствам объекта
            const safeGet = (obj, path, defaultValue = '') => {
                if (!obj) return defaultValue;
                const keys = path.split('.');
                let result = obj;
                for (const key of keys) {
                    result = result?.[key];
                    if (result === undefined || result === null) {
                        return defaultValue;
                    }
                }
                return result;
            };
            
            // Вспомогательная функция для безопасной установки innerHTML
            const safeSetInnerHTML = (elementId, html) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = html;
                } else {
                    console.warn(`Элемент с ID '${elementId}' не найден`);
                }
            };
            
            // Основные размеры
            const basicDimensions = data.basic_dimensions || {};
            const basicDimensionsHtml = Object.entries(basicDimensions)
                .filter(([key]) => key !== '_raw') // Исключаем _raw из отображения
                .map(([key, value]) => `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`)
                .join('');
            safeSetInnerHTML('basicDimensions', basicDimensionsHtml);
            
            // Земляные работы
            if (data.earthworks) {
                const earthworksHtml = Object.entries(data.earthworks)
                    .map(([key, value]) => `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`)
                    .join('');
                safeSetInnerHTML('earthworks', earthworksHtml);
            }
            
            // Бетонные работы
            if (data.concrete_works) {
                const concreteHtml = Object.entries(data.concrete_works)
                    .map(([key, value]) => `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`)
                    .join('');
                safeSetInnerHTML('concrete', concreteHtml);
            }
            
            // Опалубка и армирование
            if (data.formwork) {
                const formworkHtml = Object.entries(data.formwork)
                    .map(([key, value]) => `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`)
                    .join('');
                safeSetInnerHTML('formwork', formworkHtml);
            }
            
            // Отделочные работы
            let finishingHtml = '';
            const finishingCost = data.finishing_cost || {};
            const poolData = safeGet(data, 'pool_data', {});
            const profileId = safeGet(poolData, 'profile.id', 'kp1');
            
            if (Object.keys(finishingCost).length > 0) {
                if (profileId === 'kp1') {
                    // Вариант для лайнера (KP1)
                    const area = safeGet(finishingCost, 'area', 0);
                    const perimeter = safeGet(finishingCost, 'perimeter', 0);
                    const liningCost = safeGet(finishingCost, 'lining.cost_str', '0 руб.');
                    const copingstoneCost = safeGet(finishingCost, 'coping_stone.cost_str', '0 руб.');
                    const totalCost = safeGet(finishingCost, 'total_cost_str', '0 руб.');
                    
                    finishingHtml = `
                        <div class="cost-item"><span>Площадь отделки:</span> <span>${typeof area === 'number' ? area.toFixed(1) : area} м²</span></div>
                        <div class="cost-item"><span>Периметр для копингового камня:</span> <span>${typeof perimeter === 'number' ? perimeter.toFixed(1) : perimeter} м/п</span></div>
                        <div class="cost-item"><span>Стоимость лайнера:</span> <span>${liningCost}</span></div>
                        <div class="cost-item"><span>Стоимость копингового камня:</span> <span>${copingstoneCost}</span></div>
                        <div class="total-cost"><span>Итого по отделке:</span> <span>${totalCost}</span></div>
                    `;
                } else if (profileId === 'kp2' && finishingCost.materials) {
                    // Вариант для плитки (KP2)
                    let materialsHtml = '';
                    for (const [key, value] of Object.entries(finishingCost.materials || {})) {
                        materialsHtml += `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`;
                    }
                    
                    let worksHtml = '';
                    for (const [key, value] of Object.entries(finishingCost.works || {})) {
                        worksHtml += `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`;
                    }
                    
                    const area = safeGet(finishingCost, 'area', 0);
                    const perimeter = safeGet(finishingCost, 'perimeter', 0);
                    const totalCost = safeGet(finishingCost, 'total_cost_str', '0 руб.');
                    
                    finishingHtml = `
                        <div class="cost-item"><span>Площадь отделки:</span> <span>${typeof area === 'number' ? area.toFixed(1) : area} м²</span></div>
                        <div class="cost-item"><span>Периметр для копингового камня:</span> <span>${typeof perimeter === 'number' ? perimeter.toFixed(1) : perimeter} м/п</span></div>
                        ${materialsHtml}
                        ${worksHtml}
                        <div class="total-cost"><span>Итого по отделке:</span> <span>${totalCost}</span></div>
                    `;
                } else {
                    // Упрощенный вариант для других профилей
                    const area = safeGet(finishingCost, 'area', 0);
                    const perimeter = safeGet(finishingCost, 'perimeter', 0);
                    const materialCost = safeGet(finishingCost, 'material_cost_str', '0 руб.');
                    const workCost = safeGet(finishingCost, 'work_cost_str', '0 руб.');
                    const totalCost = safeGet(finishingCost, 'total_cost_str', '0 руб.');
                    
                    finishingHtml = `
                        <div class="cost-item"><span>Площадь отделки:</span> <span>${typeof area === 'number' ? area.toFixed(1) : area} м²</span></div>
                        <div class="cost-item"><span>Периметр для копингового камня:</span> <span>${typeof perimeter === 'number' ? perimeter.toFixed(1) : perimeter} м/п</span></div>
                        <div class="cost-item"><span>Стоимость материалов:</span> <span>${materialCost}</span></div>
                        <div class="cost-item"><span>Стоимость работ:</span> <span>${workCost}</span></div>
                        <div class="total-cost"><span>Итого по отделке:</span> <span>${totalCost}</span></div>
                    `;
                }
            }
            safeSetInnerHTML('finishing', finishingHtml);
            
            // Стоимость материалов
            let materialsCostHtml = '';
            const materialsCost = data.materials_cost || {};
            if (materialsCost.materials) {
                for (const [key, value] of Object.entries(materialsCost.materials)) {
                    materialsCostHtml += `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`;
                }
                materialsCostHtml += `<div class="total-cost"><span>Итого по материалам:</span> <span>${materialsCost.total_cost_str || ''}</span></div>`;
            }
            safeSetInnerHTML('materialsCost', materialsCostHtml);
            
            // Стоимость работ
            let worksCostHtml = '';
            const worksCost = data.works_cost || {};
            if (worksCost.works) {
                for (const [key, value] of Object.entries(worksCost.works)) {
                    worksCostHtml += `<div class="cost-item"><span>${key}:</span> <span>${value}</span></div>`;
                }
                worksCostHtml += `<div class="total-cost"><span>Итого по работам:</span> <span>${worksCost.total_cost_str || ''}</span></div>`;
            }
            safeSetInnerHTML('worksCost', worksCostHtml);
            
            // Заполнение таблиц детализированного КП
            const kpItems = data.kp_items || {};
            
            // Проверяем наличие элементов для таблиц
            const equipmentItemsTable = document.getElementById('equipmentItemsTable');
            const materialsItemsTable = document.getElementById('materialsItemsTable');
            const worksItemsTable = document.getElementById('worksItemsTable');
            
            // Оборудование
            if (kpItems.equipment_items && equipmentItemsTable) {
                let equipmentHtml = '';
                kpItems.equipment_items.forEach((item, index) => {
                    const itemTotal = (item.qty || 0) * (item.price || 0);
                    equipmentHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name || ''}</td>
                            <td>${item.unit || ''}</td>
                            <td>${item.qty || 0}</td>
                            <td>${formatCurrency(item.price)}</td>
                            <td>${formatCurrency(itemTotal)}</td>
                        </tr>
                    `;
                });
                equipmentItemsTable.innerHTML = equipmentHtml;
                
                const equipmentItemsTotal = document.getElementById('equipmentItemsTotal');
                if (equipmentItemsTotal) {
                    equipmentItemsTotal.textContent = formatCurrency(kpItems.equipment_total);
                }
            }
            
            // Материалы
            if (kpItems.materials_items && materialsItemsTable) {
                let materialsHtml = '';
                kpItems.materials_items.forEach((item, index) => {
                    const itemTotal = (item.qty || 0) * (item.price || 0);
                    materialsHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name || ''}</td>
                            <td>${item.unit || ''}</td>
                            <td>${item.qty || 0}</td>
                            <td>${formatCurrency(item.price)}</td>
                            <td>${formatCurrency(itemTotal)}</td>
                        </tr>
                    `;
                });
                materialsItemsTable.innerHTML = materialsHtml;
                
                const materialsItemsTotal = document.getElementById('materialsItemsTotal');
                if (materialsItemsTotal) {
                    materialsItemsTotal.textContent = formatCurrency(kpItems.materials_total);
                }
            }
            
            // Работы
            if (kpItems.works_items && worksItemsTable) {
                let worksHtml = '';
                kpItems.works_items.forEach((item, index) => {
                    const itemTotal = (item.qty || 0) * (item.price || 0);
                    worksHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name || ''}</td>
                            <td>${item.unit || ''}</td>
                            <td>${item.qty || 0}</td>
                            <td>${formatCurrency(item.price)}</td>
                            <td>${formatCurrency(itemTotal)}</td>
                        </tr>
                    `;
                });
                worksItemsTable.innerHTML = worksHtml;
                
                const worksItemsTotal = document.getElementById('worksItemsTotal');
                if (worksItemsTotal) {
                    worksItemsTotal.textContent = formatCurrency(kpItems.works_total);
                }
            }
            
            // Заполнение итоговой таблицы
            const costs = data.costs || {};

            // Безопасно устанавливаем значения элементов, проверяя их существование
            const safeSetTextContent = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`Элемент с ID '${elementId}' не найден`);
                }
            };
            
            safeSetTextContent('totalEquipmentCost', formatCurrency(safeGet(kpItems, 'equipment_total', 0)));
            safeSetTextContent('totalMaterialsCost', formatCurrency(safeGet(kpItems, 'materials_total', 0)));
            safeSetTextContent('totalWorksCost', formatCurrency(safeGet(kpItems, 'works_total', 0)));
            safeSetTextContent('grandTotalCost', formatCurrency(safeGet(costs, 'total', 0)));
            
            // Стоимость материалов и оборудования (для обратной совместимости)
            const equipmentCostHtml = `<div class="total-cost"><span>Итого по оборудованию:</span> <span>${formatCurrency(safeGet(kpItems, 'equipment_total', 0))}</span></div>`;
            safeSetInnerHTML('equipmentCost', equipmentCostHtml);
            
            // Итоговая стоимость (сводная)
            const totalCostHtml = `
                <div class="cost-item"><span>Стоимость материалов:</span> <span>${formatCurrency(safeGet(costs, 'materials_total', 0))}</span></div>
                <div class="cost-item"><span>Стоимость работ:</span> <span>${formatCurrency(safeGet(costs, 'works_total', 0))}</span></div>
                <div class="cost-item"><span>Стоимость оборудования:</span> <span>${formatCurrency(safeGet(costs, 'equipment_total', 0))}</span></div>
                <div class="total-cost"><span>ИТОГО:</span> <span>${formatCurrency(safeGet(costs, 'total', 0))}</span></div>
            `;
            safeSetInnerHTML('totalCost', totalCostHtml);
            
            console.log("Расчет успешно завершен и отображен");
        }
    </script>
</body>
</html> 